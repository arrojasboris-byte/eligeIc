<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plataforma Dashboard AAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF para exportar algunos informes simples a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-main: #050608;
      --bg-card: #111318;
      --bg-alt: #181b22;
      --accent: #ff4757;
      --accent-soft: #ff6b81;
      --accent-alt: #ffa502;
      --text-main: #ffffff;
      --text-muted: #a0a4b8;
      --border-subtle: #2b2f3a;
      --success: #2ecc71;
      --danger: #ff4b5c;
      --warning: #ffa502;
      --sidebar-width: 260px;
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #2f3542, #000000 45%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1400px;
      margin: 24px;
      border-radius: 24px;
      background: #050608;
      box-shadow:
        0 40px 80px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      display: flex;
      overflow: hidden;
      position: relative;
    }

    /* PIN overlay */
    .pin-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #2f3542, #000000 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .pin-modal {
      background: #0b0d12;
      border-radius: 20px;
      padding: 32px 28px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.8);
      border: 1px solid var(--border-subtle);
    }

    .pin-modal h1 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .pin-modal p {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .pin-modal input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #07080c;
      color: var(--text-main);
      font-size: 16px;
      letter-spacing: 0.2em;
      text-align: center;
      margin-bottom: 16px;
    }

    .pin-modal button {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .08s ease, opacity .1s ease;
      box-shadow: 0 10px 20px rgba(255, 71, 87, 0.4);
    }

    .pin-modal button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(255, 71, 87, 0.6);
    }

    .pin-error {
      color: var(--danger);
      font-size: 13px;
      min-height: 18px;
      margin-bottom: 4px;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, #080910, #050508);
      border-right: 1px solid rgba(255, 255, 255, 0.04);
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .logo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #ffd6d9, #ff4757 60%, #6b010f 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
      color: #ffffff;
    }

    .logo-text {
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .sidebar-nav {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid transparent;
      transition: background .12s ease, color .12s ease, border-color .12s ease, transform .06s ease;
    }

    .nav-item span {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .nav-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .nav-item:hover:not(.active) {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.06);
    }

    .nav-pill-indicator {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.26);
    }

    .nav-item.active .nav-pill-indicator {
      background: #fff;
    }

    .sidebar-bottom {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.75;
    }

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top left, #1f222f, #050608 45%);
      padding: 18px 20px 20px;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }

    .main-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .main-title {
      font-size: 20px;
      font-weight: 600;
    }

    .main-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .main-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 7px 13px;
      font-size: 12px;
      background: rgba(10, 11, 17, 0.8);
      color: #f8f8f8;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background .12s ease, transform .06s ease, box-shadow .12s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      border-color: transparent;
      box-shadow: 0 10px 26px rgba(255, 71, 87, 0.5);
      font-weight: 500;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      background: rgba(255, 255, 255, 0.06);
    }

    .btn-primary:hover {
      box-shadow: 0 14px 32px rgba(255, 71, 87, 0.8);
    }

    .btn-ghost {
      background: transparent;
      border-color: rgba(255, 255, 255, 0.12);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .content {
      flex: 1;
      border-radius: 18px;
      background: radial-gradient(circle at top right, #1b1f2b, #050608 55%);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 14px 16px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.18) transparent;
    }

    .content::-webkit-scrollbar {
      width: 6px;
    }

    .content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
    }

    .section {
      display: none;
      animation: fadeIn .14s ease-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 10px;
      gap: 10px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
    }

    .section-description {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .section-actions {
      display: flex;
      gap: 6px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .card {
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, #11131a, #050608);
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 10px 12px;
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill-soft {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 8px;
      background: rgba(255, 255, 255, 0.06);
      color: var(--text-muted);
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      margin-top: 2px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-trend {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 7px;
      background: rgba(46, 204, 113, 0.1);
      color: var(--success);
    }

    .badge-trend.down {
      background: rgba(255, 75, 92, 0.1);
      color: var(--danger);
    }

    /* Tables and forms */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 11px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      background: #05070d;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--text-main);
      font-size: 11px;
      padding: 6px 7px;
      outline: none;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-2 {
      grid-column: span 2;
    }

    .field-3 {
      grid-column: span 3;
    }

    .field-full {
      grid-column: 1 / -1;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.04);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .dot-green { background: var(--success); }
    .dot-red { background: var(--danger); }
    .dot-orange { background: var(--warning); }
    .dot-muted { background: #555b6b; }

    /* Calendar */

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      margin-top: 8px;
    }

    .calendar-day {
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      min-height: 52px;
      padding: 4px 5px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .calendar-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .calendar-day-number {
      font-weight: 500;
      font-size: 11px;
    }

    .calendar-day-visit {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .calendar-weekday {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 4px;
      letter-spacing: 0.08em;
    }

    /* Small modal for calendar editing */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 6000;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: #0b0d12;
      border-radius: 16px;
      padding: 16px 14px;
      width: 100%;
      max-width: 360px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 500;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .text-muted {
      color: var(--text-muted);
      font-size: 11px;
    }

    .tag {
      display: inline-flex;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .checklist {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 12px;
      margin-top: 4px;
    }

    .checklist label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .checklist input[type="checkbox"] {
      width: 12px;
      height: 12px;
    }

    .divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.06);
      margin: 6px 0;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .helper {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .radio-row {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 1040px) {
      .grid-3, .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
      .field-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .sidebar {
        display: none;
      }
      .app-shell {
        margin: 0;
        border-radius: 0;
      }
    }
  </style>
</head>

<body>
  <!-- PIN overlay -->
  <div class="pin-overlay" id="pin-overlay">
    <div class="pin-modal">
      <h1>Acceso plataforma</h1>
      <p>Introduce el PIN de acceso para continuar.</p>
      <div class="pin-error" id="pin-error"></div>
      <input id="pin-input" type="password" maxlength="6" placeholder="••••••" />
      <button id="pin-button">Entrar</button>
      <p class="helper" style="margin-top:8px;">PIN de prueba: <strong>AR4321</strong></p>
    </div>
  </div>

  <div class="app-shell" id="app-shell" style="opacity:0.15; pointer-events:none;">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="logo-row">
          <div class="logo-mark">AA</div>
          <div>
            <div class="logo-text">Infinity Audio</div>
            <div class="sidebar-subtitle">Plataforma AAR</div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav" id="sidebar-nav">
        <div class="nav-item active" data-section="dashboard">
          <span>Dashboard General</span>
          <span class="nav-pill-indicator"></span>
        </div>
        <div class="nav-item" data-section="centros">
          <span>Centros</span>
          <span class="nav-pill-indicator"></span>
        </div>
        <div class="nav-item" data-section="delegados">
          <span>Delegados</span>
          <span class="nav-pill-indicator"></span>
        </div>
        <div class="nav-item" data-section="visitas">
          <span>Visitas</span>
          <span class="nav-pill-indicator"></span>
        </div>
        <div class="nav-item" data-section="informes">
          <span>Informes</span>
          <span class="nav-pill-indicator"></span>
        </div>
        <div class="nav-item" data-section="exclusivos">
          <span>Centros exclusivos</span>
          <span class="nav-pill-indicator"></span>
        </div>
      </nav>

      <div class="sidebar-bottom">
        Versión inicial · Datos en localStorage (navegador)
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="main-header">
        <div class="main-title-block">
          <div class="main-title">Panel de control AAR</div>
          <div class="main-subtitle">Seguimiento de procesos, visitas, informes y centros exclusivos.</div>
        </div>
        <div class="main-actions">
          <button class="btn btn-ghost btn-small" id="btn-descargar-html">Descargar HTML</button>
        </div>
      </header>

      <section class="content">
        <!-- DASHBOARD -->
        <section class="section active" id="section-dashboard">
          <div class="section-header">
            <div>
              <div class="section-title">Dashboard General</div>
              <div class="section-description">Resumen global: procesos, implantaciones, visitas y áreas de mejora.</div>
            </div>
            <div class="section-actions">
              <button class="btn btn-primary btn-small" onclick="guardarSeccion('dashboard')">Guardar</button>
            </div>
          </div>

          <div class="grid-3">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">% Procesos aplicados</div>
                  <div class="card-subtitle">Aplicación media en centros</div>
                </div>
                <span class="pill-soft">Último mes</span>
              </div>
              <div class="stat-value" id="stat-procesos">82%</div>
              <div class="stat-label">Objetivo ≥ 90%</div>
              <canvas id="chart-procesos" style="margin-top:8px; height:110px;"></canvas>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Implantación HIT</div>
                  <div class="card-subtitle">% centros con HIT implantado</div>
                </div>
                <span class="pill-soft">HIT</span>
              </div>
              <div class="stat-value" id="stat-hit">65%</div>
              <div class="stat-label">Centros con procesos HIT activos</div>
              <canvas id="chart-hit" style="margin-top:8px; height:110px;"></canvas>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Implantación AAR</div>
                  <div class="card-subtitle">Centros con perfil AAR</div>
                </div>
                <span class="pill-soft">AAR</span>
              </div>
              <div class="stat-value" id="stat-aar">34</div>
              <div class="stat-label">Centros certificados AAR</div>
              <canvas id="chart-aar" style="margin-top:8px; height:110px;"></canvas>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Evolución de visitas</div>
                  <div class="card-subtitle">Visitas realizadas vs total centros</div>
                </div>
                <span class="pill-soft" id="dash-visitas-label">2024</span>
              </div>
              <canvas id="chart-visitas" style="height:170px;"></canvas>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Áreas de mejora detectadas</div>
                  <div class="card-subtitle">Top categorías por nº de incidencias</div>
                </div>
                <span class="pill-soft">Últimas visitas</span>
              </div>
              <canvas id="chart-mejoras" style="height:170px;"></canvas>
            </div>
          </div>
        </section>

        <!-- CENTROS -->
        <section class="section" id="section-centros">
          <div class="section-header">
            <div>
              <div class="section-title">Centros</div>
              <div class="section-description">Listado de centros, responsables y registro de centros AAR.</div>
            </div>
            <div class="section-actions">
              <button class="btn btn-primary btn-small" onclick="guardarSeccion('centros')">Guardar</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Listado de centros</div>
                <div class="card-subtitle">Código, propietario, delegados, provincia, tipo y responsable audio.</div>
              </div>
              <span class="pill-soft">Datos demo editables</span>
            </div>

            <div class="field-row">
              <div class="field field-2">
                <label>Filtro por provincia</label>
                <input type="text" id="filtro-provincia" placeholder="Ej. Madrid" oninput="filtrarCentros()" />
              </div>
              <div class="field field-2">
                <label>Buscar por código / nombre</label>
                <input type="text" id="filtro-centro" placeholder="Ej. TET01" oninput="filtrarCentros()" />
              </div>
            </div>

            <div style="overflow-x:auto; margin-top:4px;">
              <table id="tabla-centros">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Centro</th>
                    <th>Propietario</th>
                    <th>Delegado</th>
                    <th>Provincia</th>
                    <th>Tipo</th>
                    <th>Responsable audio</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Datos de ejemplo iniciales -->
                  <tr data-codigo="TET01">
                    <td>TET01</td>
                    <td>Alain Afflelou Tetuán</td>
                    <td>Propietario 1</td>
                    <td>Ariannys</td>
                    <td>Madrid</td>
                    <td>
                      <select>
                        <option value="Sucursal">Sucursal</option>
                        <option value="Franquicia">Franquicia</option>
                      </select>
                    </td>
                    <td>
                      <select>
                        <option value="Ariannys Rojas">Ariannys Rojas</option>
                        <option value="Sonia Guasque">Sonia Guasque</option>
                      </select>
                    </td>
                    <td>
                      <button class="btn btn-small btn-ghost" onclick="crearInformeDesdeCentro('TET01')">Crear informe</button>
                    </td>
                  </tr>
                  <tr data-codigo="RM01">
                    <td>RM01</td>
                    <td>Reina Mercedes</td>
                    <td>Propietario 2</td>
                    <td>Sonia</td>
                    <td>Sevilla</td>
                    <td>
                      <select>
                        <option value="Sucursal">Sucursal</option>
                        <option value="Franquicia" selected>Franquicia</option>
                      </select>
                    </td>
                    <td>
                      <select>
                        <option value="Ariannys Rojas">Ariannys Rojas</option>
                        <option value="Sonia Guasque" selected>Sonia Guasque</option>
                      </select>
                    </td>
                    <td>
                      <button class="btn btn-small btn-ghost" onclick="crearInformeDesdeCentro('RM01')">Crear informe</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:10px;">
            <div class="card-header">
              <div>
                <div class="card-title">Registro centros AAR</div>
                <div class="card-subtitle">Datos del centro y perfil certificado (audiólogo / técnico).</div>
              </div>
            </div>

            <div class="field-row">
              <div class="field field-2">
                <label>Código centro</label>
                <input type="text" id="aar-codigo" placeholder="Ej. TET01" />
              </div>
              <div class="field field-2">
                <label>Nombre centro</label>
                <input type="text" id="aar-nombre" placeholder="Nombre comercial" />
              </div>
              <div class="field field-2">
                <label>Provincia</label>
                <input type="text" id="aar-provincia" />
              </div>
              <div class="field field-2">
                <label>Perfil certificado</label>
                <select id="aar-perfil">
                  <option value="">Seleccionar</option>
                  <option value="Audiologo">Audiólogo</option>
                  <option value="Tecnico">Técnico</option>
                </select>
              </div>
              <div class="field field-full">
                <label>Observaciones</label>
                <textarea id="aar-observaciones" placeholder="Notas relevantes del centro AAR"></textarea>
              </div>
            </div>

            <div class="actions-row">
              <button class="btn btn-primary btn-small" onclick="guardarRegistroAAR()">Añadir / actualizar centro AAR</button>
            </div>

            <div class="divider"></div>
            <div>
              <div class="card-subtitle">Centros AAR registrados</div>
              <div style="font-size:11px; margin-top:4px;" id="lista-aar-vacia">Todavía no hay registros guardados.</div>
              <ul id="lista-aar" style="margin-top:4px; font-size:11px; list-style:none; padding-left:0;"></ul>
            </div>
          </div>
        </section>

        <!-- DELEGADOS -->
        <section class="section" id="section-delegados">
          <div class="section-header">
            <div>
              <div class="section-title">Delegados</div>
              <div class="section-description">Ranking por delegado: procesos, HIT, formaciones y centros AAR.</div>
            </div>
            <div class="section-actions">
              <button class="btn btn-primary btn-small" onclick="guardarSeccion('delegados')">Guardar</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Ariannys Rojas</div>
                  <div class="card-subtitle">Delegada · Portfolio de centros</div>
                </div>
                <span class="pill-soft">Delegado 1</span>
              </div>

              <div class="field-row">
                <div class="field field-2">
                  <label>Aplicación de procesos (%)</label>
                  <input type="number" id="del-ar-procesos" value="85" min="0" max="100" />
                </div>
                <div class="field field-2">
                  <label>Aplicación HIT (%)</label>
                  <input type="number" id="del-ar-hit" value="70" min="0" max="100" />
                </div>
                <div class="field field-2">
                  <label>Formaciones relevantes (nº)</label>
                  <input type="number" id="del-ar-form" value="6" min="0" />
                </div>
                <div class="field field-2">
                  <label>Centros AAR</label>
                  <input type="number" id="del-ar-aar" value="10" min="0" />
                </div>
              </div>

              <div class="divider"></div>
              <div class="card-subtitle">Centros asignados</div>
              <ul style="margin-top:4px; font-size:11px; list-style: none; padding-left:0;">
                <li><span class="tag">TET01</span> <span class="text-muted">Tetuán · Madrid</span></li>
                <li><span class="tag">CT02</span> <span class="text-muted">Centro demo 2</span></li>
              </ul>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Sonia Guasque</div>
                  <div class="card-subtitle">Delegada · Portfolio de centros</div>
                </div>
                <span class="pill-soft">Delegado 2</span>
              </div>

              <div class="field-row">
                <div class="field field-2">
                  <label>Aplicación de procesos (%)</label>
                  <input type="number" id="del-sg-procesos" value="78" min="0" max="100" />
                </div>
                <div class="field field-2">
                  <label>Aplicación HIT (%)</label>
                  <input type="number" id="del-sg-hit" value="62" min="0" max="100" />
                </div>
                <div class="field field-2">
                  <label>Formaciones relevantes (nº)</label>
                  <input type="number" id="del-sg-form" value="4" min="0" />
                </div>
                <div class="field field-2">
                  <label>Centros AAR</label>
                  <input type="number" id="del-sg-aar" value="7" min="0" />
                </div>
              </div>

              <div class="divider"></div>
              <div class="card-subtitle">Centros asignados</div>
              <ul style="margin-top:4px; font-size:11px; list-style: none; padding-left:0;">
                <li><span class="tag">RM01</span> <span class="text-muted">Reina Mercedes · Sevilla</span></li>
                <li><span class="tag">SV02</span> <span class="text-muted">Centro demo Sevilla</span></li>
              </ul>
            </div>
          </div>
        </section>

        <!-- VISITAS -->
        <section class="section" id="section-visitas">
          <div class="section-header">
            <div>
              <div class="section-title">Visitas</div>
              <div class="section-description">Planificación de visitas, checklist y evolución sobre el total de centros.</div>
            </div>
            <div class="section-actions">
              <button class="btn btn-ghost btn-small" onclick="descargarChecklist()">Checklist en blanco</button>
              <button class="btn btn-primary btn-small" onclick="guardarSeccion('visitas')">Guardar</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Calendario de visitas</div>
                  <div class="card-subtitle">Click en el día para asignar centro y estado.</div>
                </div>
                <span class="pill-soft">A / S + código</span>
              </div>

              <div class="field-row">
                <div class="field field-2">
                  <label>Mes (solo visual)</label>
                  <input type="text" value="Julio 2024 (demo)" disabled />
                </div>
                <div class="field field-2">
                  <label>Buscar centro</label>
                  <input type="text" id="buscador-visitas" placeholder="Código o nombre" />
                </div>
              </div>

              <div class="calendar" id="calendar-grid">
                <!-- Días se generan por JS -->
              </div>
              <div class="helper" style="margin-top:6px;">
                Leyenda: <span class="status-dot dot-orange"></span> Pendiente ·
                <span class="status-dot dot-red"></span> Anulada ·
                <span class="status-dot dot-green"></span> Realizada
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Dashboard evolución de visitas</div>
                  <div class="card-subtitle">Visitas planificadas / realizadas vs total centros.</div>
                </div>
              </div>
              <canvas id="chart-visitas-dashboard" style="height:190px;"></canvas>
            </div>
          </div>
        </section>

        <!-- INFORMES -->
        <section class="section" id="section-informes">
          <div class="section-header">
            <div>
              <div class="section-title">Informes de centro</div>
              <div class="section-description">Creación de informes por centro, checklist de procesos y adjuntos.</div>
            </div>
            <div class="section-actions">
              <button class="btn btn-small btn-ghost" onclick="imprimirSeccion('informes')">Imprimir</button>
              <button class="btn btn-small btn-ghost" onclick="descargarInformePDF()">Descargar</button>
              <button class="btn btn-small btn-ghost" onclick="recargarSeccion('informes')">Actualizar</button>
              <button class="btn btn-primary btn-small" onclick="guardarSeccion('informes')">Guardar</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Datos del centro</div>
                <div class="card-subtitle">Selecciona desde buscador, tabla de centros o calendario.</div>
              </div>
              <span class="pill-soft">Autorrelleno disponible</span>
            </div>

            <div class="field-row">
              <div class="field field-2">
                <label>Buscar centro (código / nombre)</label>
                <input type="text" id="inf-buscar-centro" placeholder="Ej. TET01" />
              </div>
              <div class="field field-2">
                <label>Código centro</label>
                <input type="text" id="inf-codigo" />
              </div>
              <div class="field field-2">
                <label>Nombre centro</label>
                <input type="text" id="inf-nombre" />
              </div>
              <div class="field field-2">
                <label>Provincia</label>
                <input type="text" id="inf-provincia" />
              </div>
              <div class="field field-2">
                <label>Responsable audio</label>
                <select id="inf-responsable">
                  <option value="">Seleccionar</option>
                  <option value="Ariannys Rojas">Ariannys Rojas</option>
                  <option value="Sonia Guasque">Sonia Guasque</option>
                </select>
              </div>
              <div class="field field-2">
                <label>Fecha visita</label>
                <input type="date" id="inf-fecha" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="field-row">
              <div class="field field-2">
                <label>Audiólogo / Técnico</label>
                <input type="text" id="inf-audiologo" placeholder="Nombre y perfil" />
              </div>
              <div class="field field-2">
                <label>Tiempo de servicio (años)</label>
                <input type="number" id="inf-tiempo-servicio" min="0" step="0.5" />
              </div>
              <div class="field field-full">
                <label>Tipo de centro</label>
                <div class="radio-row">
                  <label><input type="radio" name="inf-tipo-centro" value="Corner" /> Corner</label>
                  <label><input type="radio" name="inf-tipo-centro" value="Centro exclusivo" /> Centro exclusivo</label>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="card-subtitle">Checklist de procesos (los resultados rellenan las tablas)</div>
            <div class="checklist" id="inf-checklist">
              <label><input type="checkbox" data-item="Proceso de captación" /> Proceso de captación</label>
              <label><input type="checkbox" data-item="Historia clínica" /> Historia clínica</label>
              <label><input type="checkbox" data-item="Teleaudiometría / screening" /> Teleaudiometría / screening</label>
              <label><input type="checkbox" data-item="Pruebas diagnósticas completas" /> Pruebas diagnósticas</label>
              <label><input type="checkbox" data-item="Explicación de resultados" /> Explicación de resultados</label>
              <label><input type="checkbox" data-item="Rehabilitación auditiva" /> Rehabilitación auditiva</label>
              <label><input type="checkbox" data-item="Seguimiento sistemático" /> Seguimiento sistemático</label>
              <label><input type="checkbox" data-item="Registro en HIT" /> Registro en HIT</label>
            </div>

            <div class="divider"></div>

            <div class="field-row">
              <div class="field field-full">
                <label>Formaciones relevantes / dinamización</label>
                <textarea id="inf-formaciones" placeholder="Formaciones realizadas, acciones de dinamización, campañas, etc."></textarea>
              </div>
            </div>

            <div class="divider"></div>

            <div class="card-subtitle">Imágenes adjuntas</div>
            <div class="field-row">
              <div class="field field-2">
                <label>Foto exterior</label>
                <input type="file" id="inf-img-exterior" accept="image/*" />
              </div>
              <div class="field field-2">
                <label>Foto interior</label>
                <input type="file" id="inf-img-interior" accept="image/*" />
              </div>
              <div class="field field-2">
                <label>Foto gabinete</label>
                <input type="file" id="inf-img-gabinete" accept="image/*" />
              </div>
            </div>
            <div class="helper">
              Demo front-end: las imágenes se utilizan como referencia visual; para un PDF completo con imágenes se recomienda integrar un backend o tratamiento específico.
            </div>
          </div>
        </section>

        <!-- CENTROS EXCLUSIVOS -->
        <section class="section" id="section-exclusivos">
          <div class="section-header">
            <div>
              <div class="section-title">Centros exclusivos</div>
              <div class="section-description">Cifras mensuales, previsto, acumulado y acciones por centro exclusivo.</div>
            </div>
            <div class="section-actions">
              <button class="btn btn-small btn-ghost" onclick="imprimirSeccion('exclusivos')">Imprimir</button>
              <button class="btn btn-small btn-ghost" onclick="descargarExclusivosPDF()">Descargar</button>
              <button class="btn btn-small btn-ghost" onclick="recargarSeccion('exclusivos')">Actualizar</button>
              <button class="btn btn-primary btn-small" onclick="guardarSeccion('exclusivos')">Guardar</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Dashboard general exclusivos</div>
                  <div class="card-subtitle">Cifras mensuales, previsto y acumulado.</div>
                </div>
              </div>
              <canvas id="chart-exclusivos" style="height:190px;"></canvas>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Acciones</div>
                  <div class="card-subtitle">Fechas, tipo de acción (anuncio, derivación, cita) y observaciones.</div>
                </div>
              </div>

              <div class="field-row">
                <div class="field field-2">
                  <label>Centro exclusivo</label>
                  <input type="text" id="ex-accion-centro" placeholder="Ej. TET01 Exclusivo" />
                </div>
                <div class="field field-2">
                  <label>Fecha</label>
                  <input type="date" id="ex-accion-fecha" />
                </div>
                <div class="field field-2">
                  <label>Tipo de acción</label>
                  <select id="ex-accion-tipo">
                    <option value="">Seleccionar</option>
                    <option value="Anuncio">Anuncio</option>
                    <option value="Derivación">Derivación</option>
                    <option value="Cita">Cita</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
                <div class="field field-full">
                  <label>Observaciones</label>
                  <textarea id="ex-accion-obs"></textarea>
                </div>
              </div>
              <div class="actions-row">
                <button class="btn btn-primary btn-small" onclick="agregarAccion()">Añadir acción</button>
              </div>
              <div class="divider"></div>
              <div class="card-subtitle">Acciones registradas</div>
              <ul id="ex-lista-acciones" style="margin-top:4px; font-size:11px; list-style:none; padding-left:0;"></ul>
            </div>
          </div>

          <div class="card" style="margin-top:10px;">
            <div class="card-header">
              <div>
                <div class="card-title">Detalle por centro exclusivo</div>
                <div class="card-subtitle">Cifras mensuales, previsto y acumulado.</div>
              </div>
              <span class="pill-soft">Editable · demo</span>
            </div>

            <div style="overflow-x:auto;">
              <table id="tabla-exclusivos">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Centro</th>
                    <th>Mes</th>
                    <th>Cifras mensuales</th>
                    <th>Previsto</th>
                    <th>Acumulado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>EX01</td>
                    <td>Tetuán Exclusivo</td>
                    <td>Jul-24</td>
                    <td><input type="number" value="12000" /></td>
                    <td><input type="number" value="15000" /></td>
                    <td><input type="number" value="60000" /></td>
                  </tr>
                  <tr>
                    <td>EX02</td>
                    <td>Reina Mercedes Exclusivo</td>
                    <td>Jul-24</td>
                    <td><input type="number" value="9000" /></td>
                    <td><input type="number" value="11000" /></td>
                    <td><input type="number" value="45000" /></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- Modal Visita -->
  <div class="modal-backdrop" id="modal-visita">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-visita-title">Visita</div>
        <button class="modal-close" onclick="cerrarModalVisita()">×</button>
      </div>
      <div>
        <div class="field">
          <label>Código centro</label>
          <input type="text" id="modal-visita-centro" placeholder="Ej. TET01" />
        </div>
        <div class="field" style="margin-top:6px;">
          <label>Quién visita</label>
          <select id="modal-visita-quien">
            <option value="">Seleccionar</option>
            <option value="A">A (Ariannys)</option>
            <option value="S">S (Sonia)</option>
          </select>
        </div>
        <div class="field" style="margin-top:6px;">
          <label>Estado</label>
          <select id="modal-visita-estado">
            <option value="pendiente">Pendiente (● naranja)</option>
            <option value="anulada">Anulada (● rojo)</option>
            <option value="realizada">Realizada (● verde)</option>
            <option value="sin">Sin visita</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-small btn-ghost" onclick="cerrarModalVisita()">Cancelar</button>
        <button class="btn btn-primary btn-small" onclick="guardarVisitaDia()">Guardar día</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "plataformaAAR";

    function getStore() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
      } catch (e) {
        return {};
      }
    }

    function setStore(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    /* PIN */

    function initPin() {
      const overlay = document.getElementById("pin-overlay");
      const input = document.getElementById("pin-input");
      const btn = document.getElementById("pin-button");
      const err = document.getElementById("pin-error");
      const shell = document.getElementById("app-shell");

      function unlock() {
        overlay.style.display = "none";
        shell.style.opacity = "1";
        shell.style.pointerEvents = "auto";
        sessionStorage.setItem("pin-ok", "1");
      }

      if (sessionStorage.getItem("pin-ok") === "1") {
        unlock();
        return;
      }

      btn.addEventListener("click", () => {
        const val = input.value.trim();
        if (val.toUpperCase() === "AR4321") {
          err.textContent = "";
          unlock();
        } else {
          err.textContent = "PIN incorrecto.";
        }
      });

      input.addEventListener("keydown", e => {
        if (e.key === "Enter") btn.click();
      });
    }

    /* Navegación */

    function initNav() {
      const navItems = document.querySelectorAll(".nav-item");
      navItems.forEach(item => {
        item.addEventListener("click", () => {
          const sectionId = item.getAttribute("data-section");
          navItems.forEach(n => n.classList.remove("active"));
          item.classList.add("active");
          document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
          document.getElementById("section-" + sectionId).classList.add("active");
        });
      });
    }

    /* Guardar secciones básicas */

    function guardarSeccion(nombre) {
      const store = getStore();
      if (!store[nombre]) store[nombre] = {};

      switch (nombre) {
        case "delegados":
          store.delegados = {
            ariannys: {
              procesos: document.getElementById("del-ar-procesos").value,
              hit: document.getElementById("del-ar-hit").value,
              form: document.getElementById("del-ar-form").value,
              aar: document.getElementById("del-ar-aar").value
            },
            sonia: {
              procesos: document.getElementById("del-sg-procesos").value,
              hit: document.getElementById("del-sg-hit").value,
              form: document.getElementById("del-sg-form").value,
              aar: document.getElementById("del-sg-aar").value
            }
          };
          break;
        case "centros":
          // Guardar filtro y AAR
          store.centros = store.centros || {};
          store.centros.filtroProvincia = document.getElementById("filtro-provincia").value;
          store.centros.filtroCentro = document.getElementById("filtro-centro").value;
          store.centros.aar = store.centros.aar || [];
          // Lista AAR ya mantenida al usar guardarRegistroAAR
          break;
        case "visitas":
          // Ya se guarda visita por día, aquí no añadimos nada más
          break;
        case "informes":
          store.informes = capturarInforme();
          break;
        case "exclusivos":
          store.exclusivos = capturarExclusivos();
          break;
        default:
          break;
      }

      setStore(store);
      alert("Sección '" + nombre + "' guardada en este navegador.");
    }

    function recargarSeccion(nombre) {
      const store = getStore();
      if (nombre === "informes" && store.informes) {
        pintarInforme(store.informes);
        alert("Informe cargado desde el navegador.");
      } else if (nombre === "exclusivos" && store.exclusivos) {
        pintarExclusivos(store.exclusivos);
        alert("Datos de exclusivos cargados desde el navegador.");
      } else {
        alert("No hay datos guardados para '" + nombre + "'.");
      }
    }

    /* DESCARGAR HTML ACTUAL */

    document.getElementById("btn-descargar-html").addEventListener("click", () => {
      const blob = new Blob([document.documentElement.outerHTML], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "plataforma_dashboard.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    /* CENTROS – filtro básico */

    function filtrarCentros() {
      const provFilter = document.getElementById("filtro-provincia").value.toLowerCase();
      const cenFilter = document.getElementById("filtro-centro").value.toLowerCase();
      const rows = document.querySelectorAll("#tabla-centros tbody tr");
      rows.forEach(row => {
        const txt = row.textContent.toLowerCase();
        const prov = row.children[4].textContent.toLowerCase();
        const show = (prov.includes(provFilter) || !provFilter) && (txt.includes(cenFilter) || !cenFilter);
        row.style.display = show ? "" : "none";
      });
    }

    function crearInformeDesdeCentro(codigo) {
      document.querySelector('[data-section="informes"]').click();
      const inputCodigo = document.getElementById("inf-codigo");
      const tabla = document.querySelectorAll("#tabla-centros tbody tr");
      tabla.forEach(row => {
        if (row.getAttribute("data-codigo") === codigo) {
          inputCodigo.value = codigo;
          document.getElementById("inf-nombre").value = row.children[1].textContent;
          document.getElementById("inf-provincia").value = row.children[4].textContent;
          document.getElementById("inf-responsable").value =
            row.children[6].querySelector("select").value;
        }
      });
    }

    /* Registro AAR */

    function guardarRegistroAAR() {
      const codigo = document.getElementById("aar-codigo").value.trim();
      if (!codigo) {
        alert("Introduce al menos el código del centro AAR.");
        return;
      }
      const nombre = document.getElementById("aar-nombre").value.trim();
      const provincia = document.getElementById("aar-provincia").value.trim();
      const perfil = document.getElementById("aar-perfil").value;
      const obs = document.getElementById("aar-observaciones").value.trim();

      const store = getStore();
      store.centros = store.centros || {};
      store.centros.aar = store.centros.aar || [];

      const existenteIdx = store.centros.aar.findIndex(c => c.codigo === codigo);
      const item = { codigo, nombre, provincia, perfil, observaciones: obs };
      if (existenteIdx >= 0) {
        store.centros.aar[existenteIdx] = item;
      } else {
        store.centros.aar.push(item);
      }
      setStore(store);
      pintarListaAAR(store.centros.aar);
      alert("Centro AAR guardado/actualizado.");
    }

    function pintarListaAAR(lista) {
      const ul = document.getElementById("lista-aar");
      const vacio = document.getElementById("lista-aar-vacia");
      ul.innerHTML = "";
      if (!lista || lista.length === 0) {
        vacio.style.display = "block";
        return;
      }
      vacio.style.display = "none";
      lista.forEach(c => {
        const li = document.createElement("li");
        li.textContent = `${c.codigo} · ${c.nombre || ""} · ${c.provincia || ""} · ${c.perfil || ""}`;
        ul.appendChild(li);
      });
    }

    /* VISITAS – calendario */

    const diasMesDemo = 31;

    function initCalendario() {
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      const store = getStore();
      const visitas = (store.visitas && store.visitas.dias) || {};

      for (let d = 1; d <= diasMesDemo; d++) {
        const cell = document.createElement("div");
        cell.className = "calendar-day";
        cell.dataset.dia = d;
        const header = document.createElement("div");
        header.className = "calendar-day-header";
        const num = document.createElement("div");
        num.className = "calendar-day-number";
        num.textContent = d;
        const dot = document.createElement("span");
        dot.className = "status-dot dot-muted";
        header.appendChild(num);
        header.appendChild(dot);

        const visitDiv = document.createElement("div");
        visitDiv.className = "calendar-day-visit";

        const data = visitas[d];
        if (data && data.estado && data.estado !== "sin") {
          let cls = "dot-orange";
          if (data.estado === "anulada") cls = "dot-red";
          else if (data.estado === "realizada") cls = "dot-green";
          dot.className = "status-dot " + cls;
          visitDiv.innerHTML = `<span>${data.quien || ""}${data.centro ? " · " + data.centro : ""}</span>`;
        } else {
          visitDiv.innerHTML = `<span class="text-muted">Sin visita</span>`;
        }

        cell.appendChild(header);
        cell.appendChild(visitDiv);
        cell.addEventListener("click", () => abrirModalVisita(d));
        grid.appendChild(cell);
      }

      actualizarDashboardVisitas();
    }

    function abrirModalVisita(dia) {
      document.getElementById("modal-visita").classList.add("active");
      document.getElementById("modal-visita-title").textContent = "Visita día " + dia;
      document.getElementById("modal-visita").dataset.dia = dia;

      const store = getStore();
      const visitas = (store.visitas && store.visitas.dias) || {};
      const data = visitas[dia] || {};
      document.getElementById("modal-visita-centro").value = data.centro || "";
      document.getElementById("modal-visita-quien").value = data.quien || "";
      document.getElementById("modal-visita-estado").value = data.estado || "sin";
    }

    function cerrarModalVisita() {
      document.getElementById("modal-visita").classList.remove("active");
    }

    function guardarVisitaDia() {
      const dia = document.getElementById("modal-visita").dataset.dia;
      const centro = document.getElementById("modal-visita-centro").value.trim();
      const quien = document.getElementById("modal-visita-quien").value;
      const estado = document.getElementById("modal-visita-estado").value;

      const store = getStore();
      store.visitas = store.visitas || {};
      store.visitas.dias = store.visitas.dias || {};
      store.visitas.dias[dia] = { centro, quien, estado };
      setStore(store);

      cerrarModalVisita();
      initCalendario();
    }

    /* Checklist en blanco */

    function descargarChecklist() {
      const contenido = [
        "CHECKLIST VISITA CENTRO",
        "",
        "- Proceso de captación",
        "- Historia clínica",
        "- Teleaudiometría / screening",
        "- Pruebas diagnósticas completas",
        "- Explicación de resultados",
        "- Rehabilitación auditiva",
        "- Seguimiento sistemático",
        "- Registro en HIT",
        "",
        "Observaciones:",
        "______________________________",
        "______________________________"
      ].join("\n");
      const blob = new Blob([contenido], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "checklist_visita.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* Dashboard visitas */

    function actualizarDashboardVisitas() {
      const store = getStore();
      const visitas = (store.visitas && store.visitas.dias) || {};
      let planificadas = 0;
      let realizadas = 0;
      Object.values(visitas).forEach(v => {
        if (v && v.estado && v.estado !== "sin") planificadas++;
        if (v.estado === "realizada") realizadas++;
      });

      const totalCentros = document.querySelectorAll("#tabla-centros tbody tr").length || 1;
      const ctx = document.getElementById("chart-visitas-dashboard").getContext("2d");
      if (window._chartVisitasDash) window._chartVisitasDash.destroy();
      window._chartVisitasDash = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Total centros", "Visitas planificadas", "Visitas realizadas"],
          datasets: [{
            label: "Visitas",
            data: [totalCentros, planificadas, realizadas]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#a0a4b8" } },
            y: { ticks: { color: "#a0a4b8" } }
          }
        }
      });
    }

    /* INFORMES – captura y pintado */

    function capturarInforme() {
      const checklist = [];
      document.querySelectorAll("#inf-checklist input[type='checkbox']").forEach(ch => {
        if (ch.checked) checklist.push(ch.dataset.item);
      });

      let tipo = "";
      document.querySelectorAll("input[name='inf-tipo-centro']").forEach(r => {
        if (r.checked) tipo = r.value;
      });

      return {
        codigo: document.getElementById("inf-codigo").value,
        nombre: document.getElementById("inf-nombre").value,
        provincia: document.getElementById("inf-provincia").value,
        responsable: document.getElementById("inf-responsable").value,
        fecha: document.getElementById("inf-fecha").value,
        audiologo: document.getElementById("inf-audiologo").value,
        tiempoServicio: document.getElementById("inf-tiempo-servicio").value,
        tipoCentro: tipo,
        checklist,
        formaciones: document.getElementById("inf-formaciones").value
      };
    }

    function pintarInforme(data) {
      document.getElementById("inf-codigo").value = data.codigo || "";
      document.getElementById("inf-nombre").value = data.nombre || "";
      document.getElementById("inf-provincia").value = data.provincia || "";
      document.getElementById("inf-responsable").value = data.responsable || "";
      document.getElementById("inf-fecha").value = data.fecha || "";
      document.getElementById("inf-audiologo").value = data.audiologo || "";
      document.getElementById("inf-tiempo-servicio").value = data.tiempoServicio || "";
      document.querySelectorAll("input[name='inf-tipo-centro']").forEach(r => {
        r.checked = r.value === data.tipoCentro;
      });
      document.querySelectorAll("#inf-checklist input[type='checkbox']").forEach(ch => {
        ch.checked = data.checklist && data.checklist.includes(ch.dataset.item);
      });
      document.getElementById("inf-formaciones").value = data.formaciones || "";
    }

    function imprimirSeccion(nombre) {
      const seccion = document.getElementById("section-" + nombre);
      if (!seccion) return;
      const printWindow = window.open("", "_blank");
      printWindow.document.write("<html><head><title>Impresión - " + nombre + "</title></head><body>" +
        seccion.innerHTML + "</body></html>");
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    /* INFORME PDF sencillo */

    function descargarInformePDF() {
      const { jsPDF } = window.jspdf;
      const data = capturarInforme();
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(14);
      doc.text("Informe de centro", 10, y); y += 8;
      doc.setFontSize(11);
      doc.text("Centro: " + (data.codigo || "") + " - " + (data.nombre || ""), 10, y); y += 6;
      doc.text("Provincia: " + (data.provincia || ""), 10, y); y += 6;
      doc.text("Responsable audio: " + (data.responsable || ""), 10, y); y += 6;
      doc.text("Fecha visita: " + (data.fecha || ""), 10, y); y += 6;
      doc.text("Audiólogo/Técnico: " + (data.audiologo || ""), 10, y); y += 6;
      doc.text("Tiempo servicio (años): " + (data.tiempoServicio || ""), 10, y); y += 6;
      doc.text("Tipo centro: " + (data.tipoCentro || ""), 10, y); y += 8;
      doc.text("Checklist procesos:", 10, y); y += 6;
      (data.checklist || []).forEach(c => {
        doc.text("- " + c, 12, y);
        y += 5;
      });
      y += 4;
      doc.text("Formaciones / dinamización:", 10, y); y += 6;
      const split = doc.splitTextToSize(data.formaciones || "", 180);
      doc.text(split, 10, y);

      doc.save("informe_centro.pdf");
    }

    /* EXCLUSIVOS – captura y PDF */

    function capturarExclusivos() {
      const filas = document.querySelectorAll("#tabla-exclusivos tbody tr");
      const items = [];
      filas.forEach(row => {
        const inputs = row.querySelectorAll("input[type='number']");
        items.push({
          codigo: row.children[0].textContent.trim(),
          centro: row.children[1].textContent.trim(),
          mes: row.children[2].textContent.trim(),
          mensual: inputs[0].value,
          previsto: inputs[1].value,
          acumulado: inputs[2].value
        });
      });

      const acciones = [];
      document.querySelectorAll("#ex-lista-acciones li").forEach(li => {
        acciones.push(li.dataset.json ? JSON.parse(li.dataset.json) : {});
      });

      return { items, acciones };
    }

    function pintarExclusivos(data) {
      // Tabla
      const filas = document.querySelectorAll("#tabla-exclusivos tbody tr");
      data.items && data.items.forEach((item, idx) => {
        const row = filas[idx];
        if (!row) return;
        const inputs = row.querySelectorAll("input[type='number']");
        inputs[0].value = item.mensual || 0;
        inputs[1].value = item.previsto || 0;
        inputs[2].value = item.acumulado || 0;
      });

      // Acciones
      const ul = document.getElementById("ex-lista-acciones");
      ul.innerHTML = "";
      (data.acciones || []).forEach(acc => {
        const li = document.createElement("li");
        li.dataset.json = JSON.stringify(acc);
        li.textContent = `${acc.fecha || ""} · ${acc.centro || ""} · ${acc.tipo || ""} · ${acc.obs || ""}`;
        ul.appendChild(li);
      });

      actualizarChartExclusivos();
    }

    function agregarAccion() {
      const centro = document.getElementById("ex-accion-centro").value.trim();
      const fecha = document.getElementById("ex-accion-fecha").value;
      const tipo = document.getElementById("ex-accion-tipo").value;
      const obs = document.getElementById("ex-accion-obs").value.trim();

      if (!centro || !fecha || !tipo) {
        alert("Centro, fecha y tipo de acción son obligatorios.");
        return;
      }

      const ul = document.getElementById("ex-lista-acciones");
      const li = document.createElement("li");
      const obj = { centro, fecha, tipo, obs };
      li.dataset.json = JSON.stringify(obj);
      li.textContent = `${fecha} · ${centro} · ${tipo} · ${obs}`;
      ul.appendChild(li);

      document.getElementById("ex-accion-centro").value = "";
      document.getElementById("ex-accion-fecha").value = "";
      document.getElementById("ex-accion-tipo").value = "";
      document.getElementById("ex-accion-obs").value = "";
    }

    function descargarExclusivosPDF() {
      const { jsPDF } = window.jspdf;
      const data = capturarExclusivos();
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(14);
      doc.text("Centros exclusivos - Resumen", 10, y); y += 8;
      doc.setFontSize(11);
      (data.items || []).forEach(item => {
        doc.text(`${item.codigo} - ${item.centro} (${item.mes})`, 10, y); y += 5;
        doc.text(`Mensual: ${item.mensual} · Previsto: ${item.previsto} · Acumulado: ${item.acumulado}`, 12, y);
        y += 6;
      });
      y += 4;
      doc.text("Acciones:", 10, y); y += 6;
      (data.acciones || []).forEach(a => {
        doc.text(`${a.fecha} · ${a.centro} · ${a.tipo} · ${a.obs}`, 12, y); y += 5;
      });
      doc.save("centros_exclusivos.pdf");
    }

    /* Gráficos del dashboard y exclusivos */

    function initCharts() {
      const ctxProcesos = document.getElementById("chart-procesos").getContext("2d");
      window._chartProcesos = new Chart(ctxProcesos, {
        type: "line",
        data: {
          labels: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul"],
          datasets: [{
            label: "% Procesos",
            data: [70, 72, 75, 78, 80, 82, 84],
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#a0a4b8" } },
            y: { ticks: { color: "#a0a4b8" } }
          }
        }
      });

      const ctxHit = document.getElementById("chart-hit").getContext("2d");
      window._chartHit = new Chart(ctxHit, {
        type: "doughnut",
        data: {
          labels: ["Implantado", "Pendiente"],
          datasets: [{
            data: [65, 35],
          }]
        },
        options: {
          plugins: {
            legend: { position: "bottom", labels: { color: "#a0a4b8", font: { size: 9 } } }
          }
        }
      });

      const ctxAar = document.getElementById("chart-aar").getContext("2d");
      window._chartAar = new Chart(ctxAar, {
        type: "bar",
        data: {
          labels: ["Ene", "Feb", "Mar", "Abr", "May", "Jun"],
          datasets: [{
            label: "Centros AAR",
            data: [20, 22, 24, 27, 30, 34],
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#a0a4b8" } },
            y: { ticks: { color: "#a0a4b8" } }
          }
        }
      });

      const ctxVisitas = document.getElementById("chart-visitas").getContext("2d");
      window._chartVisitas = new Chart(ctxVisitas, {
        type: "line",
        data: {
          labels: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul"],
          datasets: [{
            label: "Visitas realizadas",
            data: [10, 15, 18, 22, 25, 28, 32],
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#a0a4b8" } },
            y: { ticks: { color: "#a0a4b8" } }
          }
        }
      });

      const ctxMejoras = document.getElementById("chart-mejoras").getContext("2d");
      window._chartMejoras = new Chart(ctxMejoras, {
        type: "bar",
        data: {
          labels: ["Proceso", "HIT", "Formación", "Atención", "Documentación"],
          datasets: [{
            label: "Incidencias",
            data: [14, 9, 6, 11, 5],
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#a0a4b8" } },
            y: { ticks: { color: "#a0a4b8" } }
          }
        }
      });

      actualizarChartExclusivos();
    }

    function actualizarChartExclusivos() {
      const filas = document.querySelectorAll("#tabla-exclusivos tbody tr");
      const labels = [];
      const mensual = [];
      const previsto = [];
      filas.forEach(row => {
        labels.push(row.children[1].textContent.trim());
        const inputs = row.querySelectorAll("input[type='number']");
        mensual.push(parseFloat(inputs[0].value || "0"));
        previsto.push(parseFloat(inputs[1].value || "0"));
      });

      const ctx = document.getElementById("chart-exclusivos").getContext("2d");
      if (window._chartExclusivos) window._chartExclusivos.destroy();
      window._chartExclusivos = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Mensual", data: mensual },
            { label: "Previsto", data: previsto }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { ticks: { color: "#a0a4b8" } },
            y: { ticks: { color: "#a0a4b8" } }
          }
        }
      });
    }

    /* INIT */

    window.addEventListener("DOMContentLoaded", () => {
      initPin();
      initNav();
      initCalendario();
      initCharts();

      // Cargar AAR guardados si existen
      const store = getStore();
      if (store.centros && store.centros.aar) pintarListaAAR(store.centros.aar);
      if (store.informes) pintarInforme(store.informes);
      if (store.exclusivos) pintarExclusivos(store.exclusivos);
    });
  </script>
</body>
</html>


